<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Unity Automobile</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- DataTables CSS -->
    <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet">

    <!-- Google Fonts, Supabase JS, Feather Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <link rel="icon" type="image/png" href="/unity.png">

    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f4f6f9;
        }
        #sidebar {
            min-height: 100vh;
            background-color: #fff;
            box-shadow: 0 0 2rem 0 rgba(0,0,0,.05);
        }
        .nav-link {
            color: #555;
            font-weight: 500;
            display: flex;
            align-items: center;
        }
        .nav-link svg.feather {
            margin-right: 0.75rem;
            width: 20px;
            height: 20px;
            color: #888;
        }
        .nav-link.active, .nav-link:hover {
            background-color: #0d6efd;
            color: #fff;
            border-radius: 0.5rem;
        }
        .nav-link.active svg.feather, .nav-link:hover svg.feather {
            color: #fff;
        }
        .btn-loading { 
            position: relative; 
            pointer-events: none; 
            color: transparent !important; 
        }
        .btn-loading::after { 
            content: ''; 
            position: absolute; 
            left: 50%; 
            top: 50%; 
            width: 20px; 
            height: 20px; 
            margin-left: -10px; 
            margin-top: -10px; 
            border: 2px solid #fff; 
            border-top-color: transparent; 
            border-radius: 50%; 
            animation: spin 0.6s linear infinite; 
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        @media (max-width: 768px) {
            #sidebar {
                position: fixed;
                top: 0;
                left: -280px;
                width: 280px;
                z-index: 1030;
                transition: left 0.3s ease;
            }
            #sidebar.active {
                left: 0;
            }
            #content {
                width: 100%;
            }
            #sidebar-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0,0,0,0.5);
                z-index: 1029;
                display: none;
            }
            #sidebar-overlay.active {
                display: block;
            }
        }
    </style>
</head>
<body>
    <div class="d-flex">
        <div id="sidebar-overlay"></div>
        <!-- Sidebar -->
        <div id="sidebar" class="d-flex flex-column flex-shrink-0 p-3">
            <a href="#" class="d-flex align-items-center mb-3 mb-md-0 me-md-auto text-dark text-decoration-none">
                <span class="fs-4">Unity Automobile</span>
            </a>
            <hr>
            <ul class="nav nav-pills flex-column mb-auto">
                <li class="nav-item mb-1"><a href="#" class="nav-link" data-section="dashboard"><i data-feather="activity"></i>Dashboard</a></li>
                <li class="nav-item mb-1"><a href="#" class="nav-link active" data-section="profile"><i data-feather="user"></i>Profil Usaha</a></li>
                <li class="nav-item mb-1"><a href="#" class="nav-link" data-section="services"><i data-feather="tool"></i>Layanan</a></li>
                <li class="nav-item mb-1"><a href="#" class="nav-link" data-section="testimonials"><i data-feather="message-square"></i>Testimoni</a></li>
                <li class="nav-item mb-1"><a href="#" class="nav-link" data-section="gallery"><i data-feather="image"></i>Galeri</a></li>
                <li class="nav-item mb-1"><a href="#" class="nav-link" data-section="insurance"><i data-feather="shield"></i>Asuransi</a></li>
                <li class="nav-item mb-1"><a href="#" class="nav-link" data-section="contacts"><i data-feather="phone-incoming"></i>Kontak Masuk</a></li>
            </ul>
            <hr>
            <div>
                <button id="logout-button" class="btn btn-outline-danger w-100">Sign out</button>
            </div>
        </div>

        <!-- Main Content -->
        <div id="content" class="w-100">
            <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
                <div class="container-fluid">
                    <button class="navbar-toggler" type="button" id="sidebar-toggle">
                        <span class="navbar-toggler-icon"></span>
                    </button>
                    <h2 id="section-title" class="fs-5 mb-0">Profil Usaha</h2>
                    <div class="ms-auto text-muted" id="admin-email"></div>
                </div>
            </nav>
            <main class="p-4">
                <div id="notification" class="alert d-none mb-4"></div>
                
                <!-- Sections -->
                <div id="profile-section" class="content-section"></div>
                <div id="dashboard-section" class="content-section d-none"></div>
                <div id="services-section" class="content-section d-none"></div>
                <div id="testimonials-section" class="content-section d-none"></div>
                <div id="gallery-section" class="content-section d-none"></div>
                <div id="insurance-section" class="content-section d-none"></div>
                <div id="contacts-section" class="content-section d-none"></div>
            </main>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal fade" id="service-edit-modal" tabindex="-1" aria-labelledby="serviceEditModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="serviceEditModalLabel">Edit Layanan</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="service-edit-form">
                        <input type="hidden" id="edit-service-id">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="edit-service-name" class="form-label">Nama Layanan</label>
                                <input type="text" id="edit-service-name" required class="form-control">
                            </div>
                            <div class="col-md-6">
                                <label for="edit-service-icon" class="form-label">Nama Ikon (<a href="https://feathericons.com/" target="_blank">Feather Icons</a>)</label>
                                <input type="text" id="edit-service-icon" required class="form-control">
                            </div>
                            <div class="col-12">
                                <label for="edit-service-desc" class="form-label">Deskripsi Singkat</label>
                                <textarea id="edit-service-desc" rows="2" class="form-control"></textarea>
                            </div>
                            <div class="col-12">
                                <label for="edit-service-detailed-desc" class="form-label">Deskripsi Lengkap</label>
                                <textarea id="edit-service-detailed-desc" rows="5" class="form-control"></textarea>
                            </div>
                        </div>
                        <button type="submit" id="save-service-changes-btn" class="btn btn-primary mt-3">Simpan Perubahan</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="gallery-edit-modal" tabindex="-1" aria-labelledby="galleryEditModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="galleryEditModalLabel">Edit Judul Gambar</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="gallery-edit-form">
                        <input type="hidden" id="edit-gallery-id">
                        <div class="mb-3">
                            <label for="edit-gallery-title" class="form-label">Judul Gambar</label>
                            <input type="text" id="edit-gallery-title" class="form-control">
                        </div>
                        <button type="submit" id="save-gallery-changes-btn" class="btn btn-primary">Simpan Perubahan</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="insurance-edit-modal" tabindex="-1" aria-labelledby="insuranceEditModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="insuranceEditModalLabel">Edit Rekanan Asuransi</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="insurance-edit-form">
                        <input type="hidden" id="edit-insurance-id">
                        <div class="mb-3">
                            <label for="edit-insurance-name" class="form-label">Nama Perusahaan</label>
                            <input type="text" id="edit-insurance-name" class="form-control">
                        </div>
                        <div class="mb-3">
                            <label for="edit-insurance-logo-url" class="form-label">URL Logo</label>
                            <input type="url" id="edit-insurance-logo-url" class="form-control">
                        </div>
                        <button type="submit" id="save-insurance-changes-btn" class="btn btn-primary">Simpan Perubahan</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.0.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const SUPABASE_URL = 'https://fbuwyproxqmkuwncyxmf.supabase.co'; 
            const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZidXd5cHJveHFta3V3bmN5eG1mIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc0ODc4MjEyNSwiZXhwIjoyMDY0MzU4MTI1fQ.3FMS5eJchIRpgS7CcdL7MpsMXWEh_8SyQXxOobUGzYU';
            
            if (!SUPABASE_URL || !SUPABASE_KEY) {
                document.body.innerHTML = `<div class="w-100 vh-100 d-flex align-items-center justify-content-center bg-danger-subtle text-danger-emphasis p-4 text-center">PENTING: Kredensial Supabase belum diisi.</div>`;
                return;
            }
            const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

            const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();
            if (sessionError || !session) {
                window.location.replace('admin-login.html');
                return;
            }
            document.getElementById('admin-email').textContent = session.user.email;
            feather.replace();

            // -- Global Utils --
            const showNotification = (message, type = 'success') => {
                const el = document.getElementById('notification');
                el.textContent = message;
                el.className = 'alert';
                el.classList.add(type === 'success' ? 'alert-success' : 'alert-danger');
                el.classList.remove('d-none');
                setTimeout(() => el.classList.add('d-none'), 5000);
            }
            const setLoading = (btn, isLoading) => {
                btn.classList.toggle('btn-loading', isLoading);
                btn.disabled = isLoading;
            }
            const initDataTable = (tableId) => {
                const table = $(`#${tableId}`);
                if ($.fn.DataTable.isDataTable(table)) {
                    table.DataTable().destroy();
                }
                table.DataTable({
                    responsive: true,
                    order: [[0, 'desc']]
                });
                feather.replace();
            }
            window.deleteItem = async (tableName, id, callbackName) => {
                if (!confirm(`Anda yakin ingin menghapus item ini dari tabel ${tableName}?`)) return;
                const { error } = await supabaseClient.from(tableName).delete().eq('id', id);
                if (error) {
                    showNotification(`Gagal: ${error.message}`, 'error');
                } else {
                    showNotification('Item berhasil dihapus.');
                    if (callbackName && window[callbackName]) {
                        window[callbackName]();
                    }
                }
            }
            window.deleteStorageItem = async (bucketName, publicUrl, tableName, id, callbackName) => {
                if (!confirm('PERHATIAN: Ini akan menghapus data dari database DAN file dari storage. Lanjutkan?')) return;
                const filePath = decodeURIComponent(publicUrl.split(`/${bucketName}/`)[1]);
                await supabaseClient.storage.from(bucketName).remove([filePath]);
                await window.deleteItem(tableName, id, callbackName);
            }
            window.updateContactStatus = async (contactId, newStatus) => {
                const { data, error } = await supabaseClient.from('contacts').update({ status: newStatus }).eq('id', contactId).select();
                if (error) {
                    showNotification(`Gagal update status: ${error.message}. Pastikan kolom 'status' ada di tabel 'contacts'.`, 'error');
                } else {
                    if (data && data.length > 0) {
                         showNotification(`Status untuk kontak ID ${data[0].id} berhasil diperbarui ke '${data[0].status}'.`, 'success');
                    } else {
                        showNotification('Update berhasil, namun data tidak kembali. Kemungkinan RLS atau ID tidak cocok.', 'warning');
                    }
                    loadContacts();
                }
            };

            // -- Render & Load Functions --

            // Profile
            const loadProfileData = async () => {
                const { data, error } = await supabaseClient.from('company_profile').select('*').eq('id', 1).single();
                if (error && error.code !== 'PGRST116') showNotification('Gagal memuat profil usaha.', 'error');
                else {
                    const section = document.getElementById('profile-section');
                    section.innerHTML = `
                    <div class="card"><div class="card-header">Informasi Usaha</div><div class="card-body"><form id="profile-form">
                        <div class="row g-3">
                            <div class="col-md-6"><label for="company_name" class="form-label">Nama Bengkel</label><input type="text" id="company_name" class="form-control" value="${data.company_name || ''}"></div>
                            <div class="col-md-6"><label for="tagline" class="form-label">Tagline</label><input type="text" id="tagline" class="form-control" value="${data.tagline || ''}"></div>
                            <div class="col-12"><label for="about_us" class="form-label">Tentang Kami</label><textarea id="about_us" rows="4" class="form-control">${data.about_us || ''}</textarea></div>
                            <div class="col-md-6"><label for="phone_number" class="form-label">No. Telepon</label><input type="text" id="phone_number" class="form-control" value="${data.phone_number || ''}"></div>
                            <div class="col-md-6"><label for="whatsapp_number" class="form-label">No. WhatsApp (62)</label><input type="text" id="whatsapp_number" class="form-control" value="${data.whatsapp_number || ''}"></div>
                            <div class="col-12"><label for="email" class="form-label">Email</label><input type="email" id="email" class="form-control" value="${data.email || ''}"></div>
                            <div class="col-12"><label for="address" class="form-label">Alamat</label><textarea id="address" rows="2" class="form-control">${data.address || ''}</textarea></div>
                            <div class="col-md-6"><label for="operating_hours_weekdays" class="form-label">Jam Kerja</label><input type="text" id="operating_hours_weekdays" class="form-control" value="${data.operating_hours_weekdays || ''}"></div>
                            <div class="col-md-6"><label for="operating_hours_weekend" class="form-label">Jam Akhir Pekan</label><input type="text" id="operating_hours_weekend" class="form-control" value="${data.operating_hours_weekend || ''}"></div>
                            <div class="col-12"><label for="map_embed_url" class="form-label">URL Google Maps</label><textarea id="map_embed_url" rows="3" class="form-control font-monospace">${data.map_embed_url || ''}</textarea></div>
                        </div>
                        <div class="mt-3 text-end"><button type="submit" id="save-profile-btn" class="btn btn-primary">Simpan Perubahan</button></div>
                    </form></div></div>`;
                    setupProfileForm();
                }
            };
            const setupProfileForm = () => {
                document.getElementById('profile-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const btn = document.getElementById('save-profile-btn');
                    setLoading(btn, true);
                    const updates = { id: 1, updated_at: new Date(),
                        company_name: document.getElementById('company_name').value, tagline: document.getElementById('tagline').value,
                        about_us: document.getElementById('about_us').value, phone_number: document.getElementById('phone_number').value,
                        whatsapp_number: document.getElementById('whatsapp_number').value, email: document.getElementById('email').value,
                        address: document.getElementById('address').value, operating_hours_weekdays: document.getElementById('operating_hours_weekdays').value,
                        operating_hours_weekend: document.getElementById('operating_hours_weekend').value, map_embed_url: document.getElementById('map_embed_url').value,
                    };
                    const { error } = await supabaseClient.from('company_profile').upsert(updates);
                    if(error) showNotification(`Gagal menyimpan: ${error.message}`, 'error');
                    else showNotification('Profil usaha berhasil diperbarui!', 'success');
                    setLoading(btn, false);
                });
            };

            // Dashboard
            const loadDashboardStats = async () => {
                const section = document.getElementById('dashboard-section');
                section.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>';

                const tables = ['services', 'testimonials', 'gallery_images', 'insurance_partners', 'contacts'];
                let stats = {};
                for (const table of tables) {
                    const { count, error } = await supabaseClient.from(table).select('*', { count: 'exact', head: true });
                    stats[table] = error ? 'N/A' : count;
                }

                const { data: recentContacts, error: contactsError } = await supabaseClient.from('contacts').select('name, created_at').order('created_at', { ascending: false }).limit(5);

                let recentContactsHtml = '<p class="text-muted">Belum ada kontak masuk.</p>';
                if (recentContacts && recentContacts.length > 0) {
                    recentContactsHtml = '<ul class="list-group list-group-flush">';
                    recentContacts.forEach(contact => {
                        recentContactsHtml += `<li class="list-group-item d-flex justify-content-between align-items-center">${contact.name}<span class="text-muted small">${new Date(contact.created_at).toLocaleDateString("id-ID")}</span></li>`;
                    });
                    recentContactsHtml += '</ul>';
                }

                section.innerHTML = `
                    <div class="row">
                        <div class="col-xl-3 col-md-6 mb-4"><div class="card text-bg-primary shadow h-100"><div class="card-body"><div class="d-flex justify-content-between align-items-center"><div><div class="text-uppercase mb-1">Layanan</div><div class="h5 mb-0 fw-bold">${stats.services}</div></div><i data-feather="tool" class="fs-2"></i></div></div></div></div>
                        <div class="col-xl-3 col-md-6 mb-4"><div class="card text-bg-success shadow h-100"><div class="card-body"><div class="d-flex justify-content-between align-items-center"><div><div class="text-uppercase mb-1">Testimoni</div><div class="h5 mb-0 fw-bold">${stats.testimonials}</div></div><i data-feather="message-square" class="fs-2"></i></div></div></div></div>
                        <div class="col-xl-3 col-md-6 mb-4"><div class="card text-bg-info shadow h-100"><div class="card-body"><div class="d-flex justify-content-between align-items-center"><div><div class="text-uppercase mb-1">Galeri</div><div class="h5 mb-0 fw-bold">${stats.gallery_images}</div></div><i data-feather="image" class="fs-2"></i></div></div></div></div>
                        <div class="col-xl-3 col-md-6 mb-4"><div class="card text-bg-warning shadow h-100"><div class="card-body"><div class="d-flex justify-content-between align-items-center"><div><div class="text-uppercase mb-1">Kontak Masuk</div><div class="h5 mb-0 fw-bold">${stats.contacts}</div></div><i data-feather="phone-incoming" class="fs-2"></i></div></div></div></div>
                    </div>
                    <div class="row">
                        <div class="col-lg-12 mb-4">
                            <div class="card shadow mb-4">
                                <div class="card-header d-flex align-items-center"><i data-feather="activity" class="me-2"></i>Aktivitas Terbaru</div>
                                <div class="card-body">${recentContactsHtml}</div>
                            </div>
                            <div class="card shadow">
                                <div class="card-header d-flex align-items-center"><i data-feather="bar-chart-2" class="me-2"></i>Live Visitor Analytics</div>
                                <div class="card-body text-center">
                                    <p class="text-muted">Karena website Anda di-hosting di Vercel, Anda mendapatkan akses ke analytics real-time yang canggih.</p>
                                    <a href="https://vercel.com/dashboard" target="_blank" class="btn btn-primary">Buka Vercel Dashboard</a>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                feather.replace();
            };

            // Services
            const loadServices = async () => {
                const section = document.getElementById('services-section');
                section.innerHTML = `<div class="card mb-4"><div class="card-header">Tambah Layanan Baru</div><div class="card-body"><form id="service-form"><div class="row g-3"><div class="col-md-6"><label for="service-name" class="form-label">Nama Layanan</label><input type="text" id="service-name" required class="form-control"></div><div class="col-md-6"><label for="service-icon" class="form-label">Nama Ikon (<a href="https://feathericons.com/" target="_blank">Feather Icons</a>)</label><input type="text" id="service-icon" placeholder="Contoh: tool" required class="form-control"></div><div class="col-12"><label for="service-desc" class="form-label">Deskripsi Singkat</label><textarea id="service-desc" rows="2" class="form-control"></textarea></div><div class="col-12"><label for="service-detailed-desc" class="form-label">Deskripsi Lengkap</label><textarea id="service-detailed-desc" rows="4" class="form-control"></textarea></div><div class="col-12"><button type="submit" id="add-service-btn" class="btn btn-primary">Tambah Layanan</button></div></div></form></div></div><div class="card"><div class="card-header">Daftar Layanan</div><div class="card-body"><table id="services-table" class="table table-striped" style="width:100%"><thead><tr><th>Ikon</th><th>Nama</th><th>Deskripsi</th><th>Aksi</th></tr></thead><tbody></tbody></table></div></div>`;
                setupServiceForm();
                const { data, error } = await supabaseClient.from('services').select('*').order('created_at');
                if (error) { showNotification(`Gagal memuat layanan: ${error.message}`, 'error'); return; }
                const tableBody = section.querySelector('tbody');
                tableBody.innerHTML = data.map(item => `
                    <tr>
                        <td><i data-feather="${item.icon_name || 'settings'}"></i></td>
                        <td>${item.name}</td>
                        <td>${item.description || ''}</td>
                        <td>
                            <button class="btn btn-sm btn-primary me-2" data-bs-toggle="modal" data-bs-target="#service-edit-modal" data-id="${item.id}" data-name="${item.name}" data-icon_name="${item.icon_name}" data-description="${item.description || ''}" data-detailed_description="${item.detailed_description || ''}"><i data-feather="edit-2"></i></button>
                            <button class="btn btn-sm btn-danger" onclick="deleteItem('services', ${item.id}, 'loadServices')"><i data-feather="trash-2"></i></button>
                        </td>
                    </tr>`).join('');
                initDataTable('services-table');
            };
            const setupServiceForm = () => {
                const serviceForm = document.getElementById('service-form');
                if (!serviceForm) return;
                serviceForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const btn = document.getElementById('add-service-btn');
                    setLoading(btn, true);
                    const { error } = await supabaseClient.from('services').insert({ 
                        name: serviceForm['service-name'].value, 
                        description: serviceForm['service-desc'].value, 
                        icon_name: serviceForm['service-icon'].value,
                        detailed_description: serviceForm['service-detailed-desc'].value
                    });
                    if (error) showNotification(`Gagal: ${error.message}`, 'error');
                    else { showNotification('Layanan berhasil ditambahkan.'); serviceForm.reset(); loadServices(); }
                    setLoading(btn, false);
                });
            };

            // Testimonials
            const loadTestimonials = async () => {
                const section = document.getElementById('testimonials-section');
                section.innerHTML = `<div class="card"><div class="card-header">Daftar Testimoni</div><div class="card-body"><table id="testimonials-table" class="table table-striped" style="width:100%"><thead><tr><th>Nama</th><th>Rating</th><th>Pesan</th></tr></thead><tbody></tbody></table></div></div>`;
                const { data, error } = await supabaseClient.from('testimonials').select('*').order('created_at', { ascending: false });
                if (error) { showNotification(`Gagal memuat testimoni: ${error.message}`, 'error'); return; }
                const tableBody = section.querySelector('tbody');
                tableBody.innerHTML = data.map(item => `<tr><td>${item.name}</td><td>${'★'.repeat(item.rating)}${'☆'.repeat(5 - item.rating)}</td><td>${item.message}</td></tr>`).join('');
                initDataTable('testimonials-table');
            };

            // Gallery
            const loadGallery = async () => {
                const section = document.getElementById('gallery-section');
                section.innerHTML = `
                    <div class="card mb-4">
                        <div class="card-header">Tambah Gambar Baru</div>
                        <div class="card-body">
                            <form id="gallery-form">
                                <div class="mb-3">
                                    <label for="gallery-title" class="form-label">Judul Gambar</label>
                                    <input type="text" id="gallery-title" class="form-control">
                                </div>
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="is_before_after">
                                    <label class="form-check-label" for="is_before_after">
                                        Ini adalah gambar Before & After
                                    </label>
                                </div>
                                <div id="single-image-upload" class="mb-3">
                                    <label for="gallery-file" class="form-label">File Gambar</label>
                                    <input type="file" id="gallery-file" accept="image/*" class="form-control">
                                </div>
                                <div id="before-after-upload" class="d-none">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="before-gallery-file" class="form-label">Gambar SEBELUM</label>
                                            <input type="file" id="before-gallery-file" accept="image/*" class="form-control">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="after-gallery-file" class="form-label">Gambar SESUDAH</label>
                                            <input type="file" id="after-gallery-file" accept="image/*" class="form-control">
                                        </div>
                                    </div>
                                </div>
                                <button type="submit" id="upload-gallery-btn" class="btn btn-primary">Unggah Gambar</button>
                            </form>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">Daftar Gambar</div>
                        <div class="card-body">
                            <table id="gallery-table" class="table table-striped" style="width:100%">
                                <thead><tr><th>Gambar</th><th>Judul</th><th>Tipe</th><th>Aksi</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>`;
                setupGalleryForm();
                const { data, error } = await supabaseClient.from('gallery_images').select('*').order('created_at', { ascending: false });
                if (error) { showNotification(`Gagal memuat galeri: ${error.message}`, 'error'); return; }
                const tableBody = section.querySelector('tbody');
                tableBody.innerHTML = data.map(item => `
                    <tr>
                        <td>
                            ${item.is_before_after
                                ? `<img src="${item.before_image_url}" height="50" class="rounded me-2" onerror="this.style.display='none'"><img src="${item.after_image_url}" height="50" class="rounded" onerror="this.style.display='none'">`
                                : `<img src="${item.image_url}" height="50" class="rounded" onerror="this.style.display='none'">`
                            }
                        </td>
                        <td>${item.title || 'Tanpa Judul'}</td>
                        <td>
                            ${item.is_before_after 
                                ? '<span class="badge bg-info">Before/After</span>' 
                                : '<span class="badge bg-secondary">Single</span>'
                            }
                        </td>
                        <td>
                            <button class="btn btn-sm btn-danger" onclick="deleteStorageItem('galeri', '${item.image_url || item.before_image_url}', 'gallery_images', ${item.id}, 'loadGallery')"><i data-feather="trash-2"></i></button>
                        </td>
                    </tr>`).join('');
                initDataTable('gallery-table');
            };
            const setupGalleryForm = () => {
                const galleryForm = document.getElementById('gallery-form');
                if (!galleryForm) return;

                const isBeforeAfterCheckbox = document.getElementById('is_before_after');
                const singleImageUpload = document.getElementById('single-image-upload');
                const beforeAfterUpload = document.getElementById('before-after-upload');

                isBeforeAfterCheckbox.addEventListener('change', (e) => {
                    if (e.target.checked) {
                        singleImageUpload.classList.add('d-none');
                        beforeAfterUpload.classList.remove('d-none');
                    } else {
                        singleImageUpload.classList.remove('d-none');
                        beforeAfterUpload.classList.add('d-none');
                    }
                });

                galleryForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const btn = document.getElementById('upload-gallery-btn');
                    setLoading(btn, true);

                    const title = e.target['gallery-title'].value;
                    const isBeforeAfter = e.target['is_before_after'].checked;

                    const uploadFile = async (file) => {
                        if (!file) return null;
                        const filePath = `public/${Date.now()}-${file.name}`;
                        const { error: uploadError } = await supabaseClient.storage.from('galeri').upload(filePath, file);
                        if (uploadError) throw uploadError;
                        const { data: { publicUrl } } = supabaseClient.storage.from('galeri').getPublicUrl(filePath);
                        return publicUrl;
                    };

                    try {
                        let dbRecord = { title, is_before_after: isBeforeAfter };

                        if (isBeforeAfter) {
                            const beforeFile = e.target['before-gallery-file'].files[0];
                            const afterFile = e.target['after-gallery-file'].files[0];
                            if (!beforeFile || !afterFile) throw new Error('Untuk mode Before/After, kedua file harus diisi.');

                            dbRecord.before_image_url = await uploadFile(beforeFile);
                            dbRecord.after_image_url = await uploadFile(afterFile);
                            // Set image_url to before image for consistency or other uses
                            dbRecord.image_url = dbRecord.before_image_url; 

                        } else {
                            const singleFile = e.target['gallery-file'].files[0];
                            if (!singleFile) throw new Error('Pilih file gambar.');
                            dbRecord.image_url = await uploadFile(singleFile);
                        }

                        const { error: dbError } = await supabaseClient.from('gallery_images').insert(dbRecord);
                        if (dbError) throw dbError;

                        showNotification('Gambar berhasil diunggah.');
                        galleryForm.reset();
                        isBeforeAfterCheckbox.dispatchEvent(new Event('change'));
                        loadGallery();

                    } catch (error) {
                        showNotification(`Gagal: ${error.message}`, 'error');
                    } finally {
                        setLoading(btn, false);
                    }
                });
            };

            // Insurance
            const loadInsurance = async () => {
                const section = document.getElementById('insurance-section');
                section.innerHTML = `<div class="card mb-4"><div class="card-header">Tambah Asuransi</div><div class="card-body"><form id="insurance-form"><div class="mb-3"><label for="insurance-name" class="form-label">Nama Perusahaan</label><input type="text" id="insurance-name" required class="form-control"></div><div class="mb-3"><label for="insurance-logo-url" class="form-label">URL Logo</label><input type="url" id="insurance-logo-url" placeholder="https://example.com/logo.png" required class="form-control"></div><button type="submit" id="add-insurance-btn" class="btn btn-primary">Tambah Asuransi</button></form></div></div><div class="card"><div class="card-header">Rekanan Asuransi</div><div class="card-body"><table id="insurance-table" class="table table-striped" style="width:100%"><thead><tr><th>Logo</th><th>Nama</th><th>Aksi</th></tr></thead><tbody></tbody></table></div></div>`;
                setupInsuranceForm();
                const { data, error } = await supabaseClient.from('insurance_partners').select('*').order('name');
                if (error) { showNotification(`Gagal memuat rekanan: ${error.message}`, 'error'); return; }
                const tableBody = section.querySelector('tbody');
                tableBody.innerHTML = data.map(item => `
                    <tr>
                        <td><img src="${item.logo_url}" height="30" onerror="this.style.display='none'"></td>
                        <td>${item.name}</td>
                        <td>
                            <button class="btn btn-sm btn-primary me-2" data-bs-toggle="modal" data-bs-target="#insurance-edit-modal" data-id="${item.id}" data-name="${item.name}" data-logo_url="${item.logo_url}"><i data-feather="edit-2"></i></button>
                            <button class="btn btn-sm btn-danger" onclick="deleteItem('insurance_partners', ${item.id}, 'loadInsurance')"><i data-feather="trash-2"></i></button>
                        </td>
                    </tr>`).join('');
                initDataTable('insurance-table');
            };
            const setupInsuranceForm = () => {
                const insuranceForm = document.getElementById('insurance-form');
                if (!insuranceForm) return;
                insuranceForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const btn = document.getElementById('add-insurance-btn');
                    setLoading(btn, true);
                    const { error } = await supabaseClient.from('insurance_partners').insert({ name: e.target['insurance-name'].value, logo_url: e.target['insurance-logo-url'].value });
                    if (error) showNotification(`Gagal: ${error.message}`, 'error');
                    else { showNotification('Asuransi berhasil ditambahkan.'); insuranceForm.reset(); loadInsurance(); }
                    setLoading(btn, false);
                });
            };

            // Contacts
            const loadContacts = async () => {
                const section = document.getElementById('contacts-section');
                section.innerHTML = `<div class="card"><div class="card-header">Kontak Masuk</div><div class="card-body"><table id="contacts-table" class="table table-striped" style="width:100%"><thead><tr><th>Tanggal</th><th>Nama</th><th>Telepon</th><th>Pesan</th><th>Status</th><th>Aksi</th></tr></thead><tbody></tbody></table></div></div>`;
                const { data, error } = await supabaseClient.from('contacts').select('*').order('created_at', { ascending: false });
                if (error) { showNotification(`Gagal memuat kontak: ${error.message}`, 'error'); return; }
                const statusColors = { 'New': 'primary', 'Sudah dihubungi': 'success', 'On process': 'warning' };
                const statusOptions = ['New', 'Sudah dihubungi', 'On process'];
                const tableBody = section.querySelector('tbody');
                tableBody.innerHTML = data.map(item => {
                    const status = item.status || 'New';
                    let selectOptions = statusOptions.map(opt => `<option value="${opt}" ${status === opt ? 'selected' : ''}>${opt}</option>`).join('');
                    return `<tr>
                        <td>${new Date(item.created_at).toLocaleDateString('id-ID')}</td>
                        <td>${item.name}</td>
                        <td>${item.phone}</td>
                        <td>${item.message}</td>
                        <td><span class="badge bg-${statusColors[status]}">${status}</span></td>
                        <td><select class="form-select form-select-sm" onchange="updateContactStatus(${item.id}, this.value)">${selectOptions}</select></td>
                    </tr>`
                }).join('');
                initDataTable('contacts-table');
            };

            // -- Modal & Edit Form Setup --
            const setupEditModals = () => {
                const galleryModal = document.getElementById('gallery-edit-modal');
                galleryModal.addEventListener('show.bs.modal', (event) => {
                    const button = event.relatedTarget;
                    const id = button.getAttribute('data-id');
                    const title = button.getAttribute('data-title');
                    galleryModal.querySelector('#edit-gallery-id').value = id;
                    galleryModal.querySelector('#edit-gallery-title').value = title;
                    feather.replace();
                });

                document.getElementById('gallery-edit-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const id = document.getElementById('edit-gallery-id').value;
                    const title = document.getElementById('edit-gallery-title').value;
                    const btn = document.getElementById('save-gallery-changes-btn');
                    setLoading(btn, true);
                    const { error } = await supabaseClient.from('gallery_images').update({ title: title }).eq('id', id);
                    if (error) showNotification(`Gagal update: ${error.message}`, 'error');
                    else {
                        showNotification('Judul gambar berhasil diperbarui.');
                        bootstrap.Modal.getInstance(galleryModal).hide();
                        loadGallery();
                    }
                    setLoading(btn, false);
                });

                const insuranceModal = document.getElementById('insurance-edit-modal');
                insuranceModal.addEventListener('show.bs.modal', (event) => {
                    const button = event.relatedTarget;
                    const id = button.getAttribute('data-id');
                    const name = button.getAttribute('data-name');
                    const logoUrl = button.getAttribute('data-logo_url');
                    insuranceModal.querySelector('#edit-insurance-id').value = id;
                    insuranceModal.querySelector('#edit-insurance-name').value = name;
                    insuranceModal.querySelector('#edit-insurance-logo-url').value = logoUrl;
                    feather.replace();
                });

                document.getElementById('insurance-edit-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const id = document.getElementById('edit-insurance-id').value;
                    const name = document.getElementById('edit-insurance-name').value;
                    const logo_url = document.getElementById('edit-insurance-logo-url').value;
                    const btn = document.getElementById('save-insurance-changes-btn');
                    setLoading(btn, true);
                    const { error } = await supabaseClient.from('insurance_partners').update({ name, logo_url }).eq('id', id);
                    if (error) showNotification(`Gagal update: ${error.message}`, 'error');
                    else {
                        showNotification('Rekanan asuransi berhasil diperbarui.');
                        bootstrap.Modal.getInstance(insuranceModal).hide();
                        loadInsurance();
                    }
                    setLoading(btn, false);
                });

                const serviceModal = document.getElementById('service-edit-modal');
                serviceModal.addEventListener('show.bs.modal', (event) => {
                    const button = event.relatedTarget;
                    const id = button.getAttribute('data-id');
                    serviceModal.querySelector('#edit-service-id').value = id;
                    serviceModal.querySelector('#edit-service-name').value = button.getAttribute('data-name');
                    serviceModal.querySelector('#edit-service-icon').value = button.getAttribute('data-icon_name');
                    serviceModal.querySelector('#edit-service-desc').value = button.getAttribute('data-description');
                    serviceModal.querySelector('#edit-service-detailed-desc').value = button.getAttribute('data-detailed_description');
                    feather.replace();
                });

                document.getElementById('service-edit-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const id = document.getElementById('edit-service-id').value;
                    const btn = document.getElementById('save-service-changes-btn');
                    setLoading(btn, true);
                    const updates = {
                        name: document.getElementById('edit-service-name').value,
                        icon_name: document.getElementById('edit-service-icon').value,
                        description: document.getElementById('edit-service-desc').value,
                        detailed_description: document.getElementById('edit-service-detailed-desc').value
                    };
                    const { error } = await supabaseClient.from('services').update(updates).eq('id', id);
                    if (error) showNotification(`Gagal update: ${error.message}`, 'error');
                    else {
                        showNotification('Layanan berhasil diperbarui.');
                        bootstrap.Modal.getInstance(serviceModal).hide();
                        loadServices();
                    }
                    setLoading(btn, false);
                });
            };

            // -- Navigation & Initial Load --
            const setupNavigation = () => {
                const links = document.querySelectorAll('.nav-link');
                const sections = document.querySelectorAll('.content-section');
                const title = document.getElementById('section-title');
                const sidebar = document.getElementById('sidebar');
                const overlay = document.getElementById('sidebar-overlay');

                const hideSidebar = () => {
                    sidebar.classList.remove('active');
                    overlay.classList.remove('active');
                };

                links.forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        const sectionId = link.getAttribute('data-section');
                        links.forEach(l => l.classList.remove('active'));
                        link.classList.add('active');
                        sections.forEach(s => s.classList.add('d-none'));
                        document.getElementById(`${sectionId}-section`).classList.remove('d-none');
                        title.textContent = link.textContent.trim();
                        
                        if (sectionId === 'profile') loadProfileData();
                        else if (sectionId === 'dashboard') loadDashboardStats();
                        else if (sectionId === 'services') loadServices();
                        else if (sectionId === 'testimonials') loadTestimonials();
                        else if (sectionId === 'gallery') loadGallery();
                        else if (sectionId === 'insurance') loadInsurance();
                        else if (sectionId === 'contacts') loadContacts();

                        if (window.innerWidth < 768) {
                           hideSidebar();
                        }
                    });
                });

                document.getElementById('sidebar-toggle').addEventListener('click', () => {
                    sidebar.classList.toggle('active');
                    overlay.classList.toggle('active');
                });
                overlay.addEventListener('click', hideSidebar);
            };

            document.getElementById('logout-button').addEventListener('click', async () => {
                await supabaseClient.auth.signOut();
                window.location.replace('admin-login.html');
            });

            // Make load functions global for callbacks
            window.loadServices = loadServices;
            window.loadTestimonials = loadTestimonials;
            window.loadGallery = loadGallery;
            window.loadInsurance = loadInsurance;
            window.loadContacts = loadContacts;

            setupNavigation();
            setupEditModals();
            loadProfileData(); // Load initial section
        });
    </script>
</body>
</html>
